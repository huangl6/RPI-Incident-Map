<!DOCTYPE html>
<html>
    <head>
        <script src='https://api.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.js'></script>
        <link href='https://api.mapbox.com/mapbox-gl-js/v0.26.0/mapbox-gl.css' rel='stylesheet' />
        <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet"> <!--Raleway Font link-->
        <link rel="stylesheet" href="style.css">

        <!--Links from Levin's code -->
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/leaflet.markercluster-src.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/leaflet.markercluster.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" />
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/MarkerCluster.Default.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/MarkerCluster.css" />

        <!--for reading the JSON-->
        <!--<script data-main="scripts/main" src="scripts/require.js"></script>-->
    </head>
    <body>
        <div>
            <!--The ID 'map' is used below to load the map-->
            <div id='map'></div>
            <!-- Information that is in the Title box in the top left corner -->
            <div id='titleBox'>
                <div id='titleBoxWords'>
                    <h1>RPI Incident Map</h1>
                    <h5>Visualization of the Incidents Reported to Public Safety</h5>
                </div>   <!-- close div titleBoxWords -->   
            </div> <!-- close div titleBox -->
            <!-- Information that is in the filter box across the bottom of the screen -->
            <div id='filterBox'>
                <div id='filterBoxWords'>
                    <h2>Filter Options:</h2>
                    <!--Specific filter option -->
                    <!-- the openNav function open the options for each filter type-->
                    <div class='filterOptions'>
                        <p onclick="openNavLocation()" class="overlaybutton">Select Location</p>
                        <p onclick="openNavType()" class="overlaybutton">Select Type of Incident</p>
                        <p onclick="openNavDate()" class="overlaybutton">Select Month</p>
                    </div>
                    <!-- Information for the Location options overlay -->
                    <div id="myNavLocation" class="overlay">
                        <!-- X is used to close the overlay informational box -->
                        <a href="javascript:void(0)" class="closebtn" onclick="closeNavLocation()">&times;</a>

                        <!-- Location Overlay content -->
                        <div class="overlayContentLocation">
                            <a onclick="setLocation('amosteaton')">Amos Eaton</a>
                            <a onclick="setLocation('barton')">Barton</a>
                            <a onclick="setLocation('barh')">BAR-H</a>
                            <a onclick="setLocation('citystation')">City Station</a>
                            <a onclick="setLocation('lally')">Lally</a>
                            <a onclick="setLocation('studentunion')">Student Union</a>
                        </div> <!-- close div overlayContentLocation-->
                    </div> <!-- close myNavLocation div -->
                    <!-- Information for the Month Selection options overlay -->
                    <div id="myNavDate" class="overlay">
                        <!-- X is used to close the overlay informational box -->
                        <a href="javascript:void(0)" class="closebtn" onclick="closeNavDate()">&times;</a>

                        <!-- Month Overlay content -->
                        <div class="overlayContentDate">
                            <a onclick="setMonth('JAN')">January 2016</a>
                            <a onclick="setMonth('FEB')">February 2016</a>
                            <a onclick="setMonth('MAR')">March 2016</a>
                            <a onclick="setMonth('APR')">April 2016</a>
                            <a onclick="setMonth('MAY')">May 2016</a>
                            <a onclick="setMonth('JUN')">June 2016</a>
                            <a onclick="setMonth('JUL')">July 2016</a>
                            <a onclick="setMonth('AUG')">August 2016</a>
                            <a onclick="setMonth('SEP')">September 2016</a>
                            <a onclick="setMonth('OCT')">October 2016</a>
                            <a onclick="setMonth('NOV')">November 2016</a>
                            <a onclick="setMonth('DEC')">December 2016</a>
                        </div> <!-- close overlayContentDate div -->
                    </div> <!--close myNavDate div -->
                    <!-- Information for the Type Selection options overlay -->
                    <div id="myNavType" class="overlay">
                        <!-- X is used to close the overlay informational box -->
                        <a href="javascript:void(0)" class="closebtn" onclick="closeNavType()">&times;</a>

                        <!-- Type of Incident Overlay content -->
                        <div class="overlayContentType">
                            <a onclick="setTypeIncident('mischief')">Mischief</a>
                            <a onclick="setTypeIncident('firealarm')">Fire Alarm</a>
                            <a onclick="setTypeIncident('medical incident')">Medical Incident</a>
                            <a onclick="setTypeIncident('intoxication')">Intoxication</a>
                            <a onclick="setTypeIncident('propertydamage')">Property Damage</a>
                            <a onclick="setTypeIncident('larceny')">Larceny</a>
                            <a onclick="setTypeIncident('assault')">Assault</a>
                        </div> <!-- close overlayContentType div -->
                    </div> <!-- close myNavType div -->

                </div> <!-- filterBoxWords -->
            </div> <!-- filterBox -->
        </div>
        <script>
        //opens the overlay for the location options
        function openNavLocation() {
            document.getElementById("myNavLocation").style.width = "100%";
        }

        //closes the overlay for the location options
        function closeNavLocation() {
            document.getElementById("myNavLocation").style.width = "0%";
        }

        //opens the overlay for the type of incident options
        function openNavType() {
            document.getElementById("myNavType").style.width = "100%";
        }

        //closes the overlay for the type of incident options
        function closeNavType() {
            document.getElementById("myNavType").style.width = "0%";
        }

        //open the overlay for the date options
        function openNavDate() {
            document.getElementById("myNavDate").style.width = "100%";
        }

        //closes the overlay for the date options
        function closeNavDate() {
            document.getElementById("myNavDate").style.width = "0%";
        }

        // Code for storing the values of the location selection
        var locationSelected;
        function setLocation(choice) {
            //set the location value based on what was clicked
            locationSelected = choice;
            //alert(locationSelected);

            //call the python function given the location
            

            //close the overlay options
            closeNavLocation();

        }

        // Code for storing the values of the location selection 
        var markers = [];
        var month_markers = [];
        var JsonStuff = [];
        var monthSelectedBool = false;
        var layer = new L.LayerGroup();
        function setMonth(choice) {
            //set the month value based on what was clicked
            monthSelected = choice;
            //alert(monthSelected);
            monthSelectedBool = true;
            //alert(monthSelectedBool);

            //call the python function given the location
            // var req = new XMLHttpRequest();
            // req.overrideMimeType("application/json");
            // req.open("GET", "incident_generator_class.py?text=" + parseInt(monthSelected), true);
            // alert("after open");
            // var target = this;

            // req.onload  = function() {target.parseJSON(req)};  
            // req.send(null);

            // parseJSON: function(req) {  
            //     if (req.status == 200) {  
            //         var jsonResponse = JSON.parse(req.responseText);
            //         alert("HERE"); 
            //         alert(jsonResponse[0]);
            //     }
            // }

            //make an HTTP request to access the corresponding JSON file
            var req = new XMLHttpRequest();
            req.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    //populate the JsonStuff with the information
                    var jsonResponse = JSON.parse(req.responseText);

                    console.log("JSON FILE:");
                    console.log(req.responseText);
                    //console.log(req.responseText.length);

                    for (var i = 0; i < jsonResponse.length; i++) {
                        //alert(JsonStuff[i].incident);
                        month_markers.push([jsonResponse[i].coordinates[0], jsonResponse[i].coordinates[1], jsonResponse[i].incident]);
                        console.log(month_markers[i]);
                    }
                    createLayers(monthSelectedBool, month_markers);
                }
            };
            req.open("GET", monthSelected+"_16.json", true);
            req.send();
            closeNavDate();
        }

        // Code for storing the values of the type selection 
        var typeSelected;
        function setTypeIncident(choice) {
            //set the type of incident value based on what was clicked
            typeSelected = choice;
            alert(typeSelected);

            //call the python function given the type of incident

            //close the overlay options
            closeNavType();

        }

        //code merged from Levin
        // var JsonStuff = [];
        // $.ajax({
        //     async: false,
        //     url: 'NOV_16.json',
        //     data: "",
        //     accepts:'application/json',
        //     dataType: 'json',
        //     success: function (data) {
        //         for (var i = 0; i < data.length; i++) {
        //             JsonStuff.push( data[i]);
        //         }
        //     }
        // });
        
        
        //var lul = new L.LayerGroup();
        var map;
        var layerControl;
        function createLayers(monthSelectedBool, markers){
            if(monthSelectedBool == false){
                //var ECAV = new L.LayerGroup();
                //var EcavMarkers = [];
                
                //console.log(JsonStuff.length)
                // for (var j = 0; j < JsonStuff.length; j++){
                //     //console.log(JsonStuff[j].location)
                //     if (JsonStuff[j].location == 'EAST CAMPUS ATHLETIC VILLAGE'){
                //         //console.log(JsonStuff[j].lon);
                //         EcavMarkers.push([JsonStuff[j].coordinates[0], JsonStuff[j].coordinates[1], JsonStuff[j].incident])
                //     }
                // }
                // console.log(EcavMarkers[0])
                // var icon_lul = L.AwesomeMarkers.icon({
                //     icon: 'none',
                //     markerColor: 'pink',
                //     prefix: 'glyphicon',
                //     extraClasses: 'fa-rotate-0'
                // });
                
                //icon type
                var icon_type = L.AwesomeMarkers.icon({
                    icon: 'none',
                    markerColor: 'blue',
                    prefix: 'glyphicon',
                    extraClasses: 'fa-rotate-0'
                });

                //display the markers
                console.log("Display the markers:" + markers.length);
                for (var i=0; i< markers.length; i++) {
                    var lat = markers[i].coordinates[0];
                    //console.log("lon ??" + markers[i].coordinates[1])
                    var lon = markers[i].coordinates[1];
                    //console.log("popup text: " + markers[i].incident)
                    var popupText = markers[i].incident;
                    //console.log("marker: " + markers[i])
                    //console.log("Lat: " + lat);
                    var markerLocation = new L.LatLng(lat, lon);
                    var marker = new L.Marker(markerLocation).bindPopup(popupText).addTo(layer);
                    marker.setIcon(icon_type);
                }
            
            
                // for (var i=0; i<markers.length; i++) {
                //     var lon = markers[i][0];
                //     var lat = markers[i][1];
                //     var popupText = markers[i][2];
                //     var markerLocation = new L.LatLng(lat, lon);
                //     var marker = new L.Marker(markerLocation).bindPopup(popupText).addTo(lul);
                //     //marker.bindPopup(popupText);
                //     marker.setIcon(icon_lul);
                // }


                var mbAttr = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                        '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                        'Imagery © <a href="http://mapbox.com">Mapbox</a>',
                    mbUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw';

                var streets  = L.tileLayer(mbUrl, {id: 'mapbox.streets',   attribution: mbAttr});

                map = L.map('map', {
                    center: [42.730105,-73.6771229],
                    zoom: 15,
                    layers: [layer]
                });
                map.options.maxZoom = 17;
                map.options.minZoom = 15;

                L.tileLayer(mbUrl, {id: 'mapbox.streets',   attribution: mbAttr}).addTo(map);
                //map.addControl(L.control.fractionalZoom({position: 'topright', zoomIncrement:.1}));
                var baseLayers = {
                    "Select Location Areas:": streets
                };

                var overlays = {
                    "LAYER": layer
                }
                layerControl = L.control.layers(baseLayers, overlays).addTo(map);
            }

            if(monthSelectedBool == true){
                //console.log(map.hasLayer(layer));
                map.removeLayer(layer);
                var month = new L.LayerGroup();

                //icon type
                var icon_type = L.AwesomeMarkers.icon({
                    icon: 'none',
                    markerColor: 'pink',
                    prefix: 'glyphicon',
                    extraClasses: 'fa-rotate-0'
                });

                //display the markers
                console.log("Display the markers:" + month_markers.length);
                for (var i=0; i< month_markers.length; i++) {
                    console.log("coordinates: " + month_markers[i][0] + " , " + month_markers[i][1])
                    var lat = month_markers[i][0];
                    //console.log("lon ??" + markers[i].coordinates[1])
                    var lon = month_markers[i][1];
                    //console.log("popup text: " + markers[i].incident)
                    var popupText = month_markers[i][2];
                    //console.log("marker: " + markers[i])
                    //console.log("Lat: " + lat);
                    var markerLocation = new L.LatLng(lat, lon);
                    var marker = new L.Marker(markerLocation).bindPopup(popupText).addTo(month);
                    marker.setIcon(icon_type);
                }

                //console.log("IN IF");

                // var mbAttr = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                //         '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                //         'Imagery © <a href="http://mapbox.com">Mapbox</a>',
                //     mbUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw';

                //var streets  = L.tileLayer(mbUrl, {id: 'mapbox.streets',   attribution: mbAttr});
                //console.log("before titleLayer");
                //L.tileLayer(mbUrl, {id: 'mapbox.streets',   attribution: mbAttr}).addTo(map);
                //map.addControl(L.control.fractionalZoom({position: 'topright', zoomIncrement:.1}));
                // var baseLayers = {
                //     "Select Location Areas:": streets
                // };
                //console.log("before map =");
                // map = L.map('map', {
                //     center: [42.730105,-73.6771229],
                //     zoom: 15,
                //     layers: [month]
                // });

                // map.options.maxZoom = 17;
                // map.options.minZoom = 15;

                // var overlays = {
                //     "LAYER": layer,
                //     "Month Selected Layer": month
                // }
                // layerControl = L.control.layers(baseLayers, overlays).addTo(map);               

                //map.addControl(L.control.fractionalZoom({position: 'topright', zoomIncrement:.1}));
                //layerControl.addOverlay( month, "MONTH");
                map.addLayer(month);
            }
               

            
        } 
        //code merged from Levin
        var initial_incidents = [];
        $.ajax({
            async: false,
            url: 'initial.json',
            data: "",
            accepts:'application/json',
            dataType: 'json',
            success: function (data) {
                for (var i = 0; i < data.length; i++) {
                    initial_incidents.push( data[i]);
                    console.log(initial_incidents[i]);
                }
            }
        });
        createLayers(false, initial_incidents);  

        </script>

    </body>
</html>
